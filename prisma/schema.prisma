// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// recommended to have `points` descending index set
model User {
  id      String   @id @default(auto()) @map("_id") @db.ObjectId
  name    String   @unique
  secret  String // if changed then all sessions will be lost (TODO add reset secret)
  joined  DateTime @default(now())
  lastActive  DateTime @default(now())

  role String?
  pendingFriends String[] //list of players to accept invites from
  friends String[] // friends ids
  email String? @unique
  bio String?
  profileHue Int?
  profileHue2 Int?
  country String?

  scores  Score[]
  songComments SongComment[]
  avatar FileAvatar?
  background FileBackground?
  notifications Notification[]
  stats UserStats[]
}

model UserStats {
  id     String @id @default(auto()) @map("_id") @db.ObjectId // filled by prisma

  user   String @db.ObjectId // id of File that stores the replay contents
  type   String?

  points4k Int?
  points5k Int?
  points6k Int?
  points7k Int?
  points8k Int?
  points9k Int?

  avgAcc4k Float?
  avgAcc5k Float?
  avgAcc6k Float?
  avgAcc7k Float?
  avgAcc8k Float?
  avgAcc9k Float?

  userRe User? @relation(fields: [user], references: [id])
}

// recommended to have `maxPoints` descending index set
model Song {
  id     String  @id @map("_id") // song name, it's difficulty and the hashed value of the chart
  scores Score[]
  comments SongComment[]
  maxPoints Float?
  verified Boolean
}

// recommended to have `score` and `points` descending index set
model Score {
  id         String @id @default(auto()) @map("_id") @db.ObjectId // filled by prisma

  score    Float
  accuracy Float
  points   Float
  sicks    Float
  goods    Float
  bads     Float
  shits    Float
  misses    Float

  playbackRate Float
  strum    Int
  keys    Int?
  category String?

  submitted DateTime @default(now())
  modURL String?

  songRe Song? @relation(fields: [songId], references: [id])
  userRe User? @relation(fields: [player], references: [id])

  songId String? // filled by prisma
  player String? @db.ObjectId // filled by prisma

  replayData String? //deprecated, TODO

  replayFileRe FileReplay? @relation(fields: [replayFileId], references: [id])
  replayFileId String? @db.ObjectId @unique // id of File that stores the replay contents
}

model Report {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId // filled by prisma
  content   String
  submitted DateTime @default(now())
  by        String
}

model SongComment {
  id      String @id @default(auto()) @map("_id") @db.ObjectId // filled by prisma
  content String
  at      Float
  userRe  User   @relation(fields: [by], references: [id])
  by      String @db.ObjectId
  song    Song   @relation(fields: [songid], references: [id])
  songid  String
}

model Club {
  id      String @id @default(auto()) @map("_id") @db.ObjectId // filled by prisma
  name    String @unique
  tag     String @unique
  members String[]
  pending String[]
  leaders String[]
  content String?
  hue     Int?
  points  BigInt
  created DateTime @default(now())
  banner  FileClubBanner?
}

model Notification {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId // filled by prisma
  date      DateTime @default(now())
  userRe    User     @relation(fields: [to], references: [id])
  to        String   @db.ObjectId
  title     String
  content   String?
  image     String?
  href      String?
}

model FileReplay {
  id      String @id @default(auto()) @map("_id") @db.ObjectId // filled by prisma
  data    Bytes
  size    BigInt
  date    DateTime @default(now())
  scoreRe Score?
}

model FileAvatar {
  id      String @id @default(auto()) @map("_id") @db.ObjectId // filled by prisma
  data    Bytes
  size    BigInt
  date    DateTime @default(now())
  ownerRe User     @relation(fields: [owner], references: [id])
  owner   String   @db.ObjectId @unique
}

model FileBackground {
  id      String @id @default(auto()) @map("_id") @db.ObjectId // filled by prisma
  data    Bytes
  size    BigInt
  date    DateTime @default(now())
  ownerRe User     @relation(fields: [owner], references: [id])
  owner   String   @db.ObjectId @unique
}

model FileClubBanner {
  id      String @id @default(auto()) @map("_id") @db.ObjectId // filled by prisma
  data    Bytes
  size    BigInt
  date    DateTime @default(now())
  clubRe  Club     @relation(fields: [clubTag], references: [tag])
  clubTag String   @unique
}